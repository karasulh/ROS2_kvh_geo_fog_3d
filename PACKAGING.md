# Packaging

To package this repository, follow these steps.

## Summary

ONLY FOLLOW THESE STEPS IF YOU ALREADY KNOW WHAT THE REST OF THIS FILE SAYS!!!

For each subdirectory containing a package:

```
catkin_generate_changelog
(edit CHANGELOG.rst. THE VERSION YOU SET HERE SHOULD MATCH WHAT YOU'RE BUMPING **TO**)
(save, add, commit, and push CHANGELOG.rst)
catkin_prepare_release --bump {major,minor,patch}
git push --tags
./packaging/release.sh
bloom-generate rosdebian --os-name ubuntu --os-version <version here> --ros-distro <ROS distro here>
./packaging/fix_rules.sh
fakeroot debian/rules binary
```

## Pre-Requisite

These commands are per-package! So, you must go into sub-directories to release each package individually.

## Step 0: Figure out your new version

NOTE: If you are unfamiliar with software versioning practice for this project, consult the software wiki here: https://confluence.mitre.org/display/MET2MIP/Versioning

You need your software version in your CHANGELOG.rst and your package.xml to match. The catkin tools do not do this automatically.

Thus, you must select how you intend to update your version. Are you updating patch, minor, or major? Look at package.xml, figure out what the current version is,
and select your next version accordingly (it should be an increment of one of the numbers).

Then, use this in the catkin changelog generation step.

## Changelog

Run the following commands:

1a) If first release

```catkin_generate_changelog --all```

1b) If subsequent releases or CHANGELOG.rst exists

```catkin_generate_changelog```

2) Edit and fix up CHANGELOG.rst

This should be done in an editor. You need to manually put in your release number that you're bumping **TO** as well as the date in
ISO 8601 format (YYYY-MM-DD).

An example of a good changelog is here: https://github.com/ros-infrastructure/ros_buildfarm/blob/master/CHANGELOG.rst

Here's a sample line:

```
2.0.1 (2018-04-30)
------------------

* Improvements

  * use egrep to find repository components in arbitrary positions (`#532 <https://github.com/ros-infrastructure/ros_buildfarm/pull/532>`_)

* Fixes

  * revert "remove using the test_depend from binary jobs" introduced in 2.0.0 (`#540 <https://github.com/ros-infrastructure/ros_buildfarm/pull/540>`_)
  * add missing import from future for Python 2 compatibility (`#537 <https://github.com/ros-infrastructure/ros_buildfarm/pull/537>`_)
```

3) Add, commit, and push your CHANGELOG.rst

## Release

To perform your release, you must do two things:

* Prepare your release using catkin's tools. This increments versions, tags your repository
* Use python-bloom to generate your debian packaging files

### Catkin preparation

Run the following command, selecting either major, minor, or patch.

"major" bumps the first number.
"minor" bumps the second number.
"patch" bumps the third number.

```
catkin_prepare_release --bump {major,minor,patch}
```

IMPORTANT: Your version that you bump **TO** must match the version you set in your CHANGELOG.rst in step 1!

After completing your prepared release, you must push your new tags!

```
git push --tags
```

### Releasing

The script packaging/release.sh will perform the bloom-release command for you, which will do a ROS-style repository release.

You must already have a release repository ready. It should be located under the Gitlab group DART-release, and should have the
suffix "-release". It should be initialized with a README.md.

## Generating local debian

### Bloom for Debian files

Run the following python-bloom command to get your debian/ directory set up, based on package.xml.

```
bloom-generate rosdebian --os-name ubuntu --os-version <version here> --ros-distro <ROS distro here>
```

Example:
```
bloom-generate rosdebian --os-name ubuntu --os-version xenial --ros-distro kinetic
```

### Handling local package dependencies

Bloom cleans your ROS environment before building, and thus if you have a package that depends on other
local packages to build, it will fail. A great example is a repository which is split into a _msgs package
containing your messages and a _driver package containing your driver.

To get around this issue, the scripts in packaging are called to fix up the debian/rules file before
packaging. Generally this is a fix_rules.sh file that adds some cmake variables to the build.

Refer to the build_deb.sh script, and the scripts under packaging/, for more details.

### Packaging

To create your debian package using the files generated by bloom, run the following command.

```
fakeroot debian/rules binary
```

This will create a debian package in the directory above your current directory.

## Uploading Packages

TODO How to upload to Aptly?
